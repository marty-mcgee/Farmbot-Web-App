---
:TAKE_PHOTO_OF_PLANT: # ==========================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
      :body:
      - :kind: parameter_declaration
        :args:
          :label: parent
          :default_value:
            :kind: coordinate
            :args:
              :x: 0
              :y: 0
              :z: 0
  :color: pink
  :pinned: true
  :name: Take photo of plant
  :body:
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: special_value
            :args:
              :label: "safe_height"
      - :kind: safe_z
        :args: {}
    :comment: Move above plant
  - :kind: take_photo
    :args: {}

:WATER_PLANT: # ==================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
      :body:
      - :kind: parameter_declaration
        :args:
          :label: parent
          :default_value:
            :kind: coordinate
            :args:
              :z: 0
              :y: 0
              :x: 0
  :color: blue
  :pinned: true
  :name: Water plant
  :body:
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: special_value
            :args:
              :label: "safe_height"
      - :kind: safe_z
        :args: {}
    :comment: Move above plant
  - :kind: write_pin
    :args:
      :pin_mode: 0
      :pin_value: 1
      :pin_number:
        :kind: named_pin
        :args:
          :pin_id: 0
          :pin_type: Peripheral
    :comment: Turn on water
  - :kind: wait
    :args:
      :milliseconds: 2000
    :comment: Wait 2 seconds
  - :kind: write_pin
    :args:
      :pin_mode: 0
      :pin_value: 0
      :pin_number:
        :kind: named_pin
        :args:
          :pin_id: 0
          :pin_type: Peripheral
    :comment: Turn off water

:PLANT_SEED_GENESIS: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
      :body:
      - :kind: parameter_declaration
        :args:
          :label: parent
          :default_value:
            :kind: coordinate
            :args:
              :z: 0
              :y: 0
              :x: 0
  :color: yellow
  :name: Plant seed
  :body:
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: special_value
            :args:
              :label: "soil_height"
      - :kind: axis_addition
        :args:
          :axis: z
          :axis_operand:
            :kind: numeric
            :args:
              :number: 150
      - :kind: safe_z
        :args: {}
    :comment: Move to above plant
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: special_value
            :args:
              :label: "soil_height"
      - :kind: axis_addition
        :args:
          :axis: z
          :axis_operand:
            :kind: numeric
            :args:
              :number: -25
      - :kind: speed_overwrite
        :args:
          :axis: z
          :speed_setting:
            :kind: numeric
            :args:
              :number: 25
    :comment: Plant seed
  - :kind: write_pin
    :args:
      :pin_mode: 0
      :pin_value: 0
      :pin_number:
        :kind: named_pin
        :args:
          :pin_id: 0
          :pin_type: Peripheral
    :comment: Turn off vacuum pump
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: special_value
            :args:
              :label: "soil_height"
      - :kind: axis_addition
        :args:
          :axis: z
          :axis_operand:
            :kind: numeric
            :args:
              :number: 150
    :comment: Retract needle
  - :kind: find_home
    :args:
      :speed: 100
      :axis: z
    :comment: Move to safe Z position

:PLANT_SEED_EXPRESS: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
      :body:
      - :kind: parameter_declaration
        :args:
          :label: parent
          :default_value:
            :kind: coordinate
            :args:
              :z: 0
              :y: 0
              :x: 0
  :color: yellow
  :name: Plant seed
  :body:
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: special_value
            :args:
              :label: "soil_height"
      - :kind: axis_addition
        :args:
          :axis: z
          :axis_operand:
            :kind: numeric
            :args:
              :number: 150
      - :kind: safe_z
        :args: {}
    :comment: Move to above plant
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: special_value
            :args:
              :label: "soil_height"
      - :kind: axis_addition
        :args:
          :axis: z
          :axis_operand:
            :kind: numeric
            :args:
              :number: -25
      - :kind: speed_overwrite
        :args:
          :axis: z
          :speed_setting:
            :kind: numeric
            :args:
              :number: 25
    :comment: Plant seed
  - :kind: write_pin
    :args:
      :pin_mode: 0
      :pin_value: 0
      :pin_number:
        :kind: named_pin
        :args:
          :pin_id: 0
          :pin_type: Peripheral
    :comment: Turn off vacuum pump
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: identifier
            :args:
              :label: parent
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: special_value
            :args:
              :label: "soil_height"
      - :kind: axis_addition
        :args:
          :axis: z
          :axis_operand:
            :kind: numeric
            :args:
              :number: 150
    :comment: Retract needle
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: numeric
            :args:
              :number: 0
    :comment: Move Z to home position

:PICK_UP_SEED_EXPRESS: # =========================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
  :color: yellow
  :name: Pick up seed
  :body:
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: tool
            :args:
              :tool_id: 0
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: tool
            :args:
              :tool_id: 0
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: tool
            :args:
              :tool_id: 0
      - :kind: axis_addition
        :args:
          :axis: z
          :axis_operand:
            :kind: numeric
            :args:
              :number: 50
      - :kind: safe_z
        :args: {}
    :comment: Move above seed trough
  - :kind: write_pin
    :args:
      :pin_mode: 0
      :pin_value: 1
      :pin_number:
        :kind: named_pin
        :args:
          :pin_id: 0
          :pin_type: Peripheral
    :comment: Turn on vacuum pump
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: tool
            :args:
              :tool_id: 0
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: tool
            :args:
              :tool_id: 0
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: tool
            :args:
              :tool_id: 0
      - :kind: speed_overwrite
        :args:
          :axis: z
          :speed_setting:
            :kind: numeric
            :args:
              :number: 25
    :comment: Pick up seed
  - :kind: move
    :args: {}
    :body:
      - :kind: axis_overwrite
        :args:
          :axis: x
          :axis_operand:
            :kind: tool
            :args:
              :tool_id: 0
      - :kind: axis_overwrite
        :args:
          :axis: y
          :axis_operand:
            :kind: tool
            :args:
              :tool_id: 0
      - :kind: axis_overwrite
        :args:
          :axis: z
          :axis_operand:
            :kind: tool
            :args:
              :tool_id: 0
      - :kind: axis_addition
        :args:
          :axis: z
          :axis_operand:
            :kind: numeric
            :args:
              :number: 50
    :comment: Move above seed trough

:WATER_ALL_PLANTS: # =========================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
  :color: green
  :name: Water all plants
  :body:
  - :kind: execute
    :args:
      :sequence_id: 0
    :body:
    - :kind: parameter_application
      :args:
        :label: parent
        :data_value:
          :kind: point_group
          :args:
            :point_group_id: 0
    :comment: Water all plants

:FIND_HOME_GENESIS: # =========================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
  :color: blue
  :name: Find Home
  :body:
  - :kind: find_home
    :args:
      :speed: 100
      :axis: all
    :comment: Find home on all axes

:FIND_HOME_EXPRESS: # =========================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
  :color: blue
  :name: Find Home
  :body:
  - :kind: find_home
    :args:
      :speed: 100
      :axis: y
    :comment: Find home on the Y axis
  - :kind: find_home
    :args:
      :speed: 100
      :axis: x
    :comment: Find home on the X axis

:MOUNT_TOOL: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
      :body:
      - :kind: parameter_declaration
        :args:
          :label: Tool
          :default_value:
            :kind: location_placeholder
            :args: {}
  :color: gray
  :name: Mount Tool
  :body:
  - :kind: lua
    :args:
      :lua: |
        mount_tool(variable("Tool"))

:DISMOUNT_TOOL: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
  :color: gray
  :name: Dismount Tool
  :body:
  - :kind: lua
    :args:
      :lua: |
        dismount_tool()

:WATER_ALL: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
  :color: blue
  :name: Water all
  :body:
  - :kind: lua
    :args:
      :lua: |
        -- Get and sort all planted plants
        plants = sort(get_plants(), "nn")

        -- Initialize job and loop
        count = 0
        job = "Watering all " .. #plants .. " plants"
        toast(job)

        -- Water each plant
        for _, plant in pairs(plants) do
            set_job(job, {
                percent = 100 * (count) / #plants,
                status = "Watering " .. (plant.name or "plant") .. " at (" .. plant.x .. ", " .. plant.y .. ")"
            })
            water(plant)
            count = count + 1
        end

        complete_job(job)


:SOIL_HEIGHT_GRID: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
  :color: gray
  :name: Soil Height Grid
  :body:
  - :kind: lua
    :args:
      :lua: |
        local grid = photo_grid()
        job = "Soil Height Grid"

        grid.each(function(cell)
            set_job(job, {
                percent = 100 * (cell.count - 0.5) / grid.total,
                status = "Moving"
            })
            move{x=cell.x, y=cell.y, z=cell.z}
            set_job(job, {
                percent = 100 * (cell.count / grid.total),
                status = "Measuring soil height"
            })
            local msg = "Measuring height at point " .. cell.count .. " of " .. grid.total
            send_message("info", msg)
            measure_soil_height()
        end)

        complete_job(job)

:PICK_FROM_SEED_TRAY: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
      :body:
      - :kind: parameter_declaration
        :args:
          :label: Seed Tray
          :default_value:
            :kind: location_placeholder
            :args: {}
      - :kind: parameter_declaration
        :args:
          :label: Seed Tray Cell
          :default_value:
            :kind: text
            :args:
              :string: B3
      - :kind: parameter_declaration
        :args:
          :label: Cell Depth
          :default_value:
            :kind: numeric
            :args:
              :number: 5
  :color: yellow
  :name: Pick from Seed Tray
  :body:
  - :kind: lua
    :args:
      :lua: |
        tray = variable("Seed Tray")
        cell_label = variable("Seed Tray Cell")
        cell = get_seed_tray_cell(tray, cell_label)
        cell_depth = variable("Cell Depth")
        seeder_tool = get_tool({name = "Seeder"})
        seeder_tip_z_offset = seeder_tool.seeder_tip_z_offset or 80
        vacuum_pump_pin = 9

        -- Checks
        if not verify_tool() then
            return
        end

        -- Send message with cell info
        toast("Picking up seed from cell " .. cell_label)

        -- Job
        function job(status, percent)
            set_job("Pick from Seed Tray", {
                status = status,
                percent = percent
            })
        end

        -- Move to above the cell
        job("Moving to seed tray", 25)
        move{
            x = cell.x,
            y = cell.y,
            z = cell.z + seeder_tip_z_offset + 25,
            grouping = "xy,z",
            route = "high"
        }

        -- Pick up seed
        job("Picking up seed", 75)
        on(vacuum_pump_pin)
        move{
            z = cell.z + seeder_tip_z_offset - cell_depth,
            speed = 50
        }

        -- Retract Z
        job("Retracting Z", 90)
        move{z=cell.z + seeder_tip_z_offset + 25}
        job("Complete", 100)

:PICK_FROM_SEED_TROUGH: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
      :body:
      - :kind: parameter_declaration
        :args:
          :label: Seed Trough
          :default_value:
            :kind: location_placeholder
            :args: {}
      - :kind: variable_declaration
        :args:
          :label: Trough Depth
          :data_value:
            :kind: numeric
            :args:
              :number: 10
  :color: yellow
  :name: Pick from Seed Trough
  :body:
  - :kind: lua
    :args:
      :lua: |
        trough = variable("Seed Trough")
        trough_depth = variable("Trough Depth")
        seeder_tool = get_tool({name = "Seeder"})
        seeder_tip_z_offset = seeder_tool.seeder_tip_z_offset or 80
        vacuum_pump_pin = 9

        -- Checks
        if not verify_tool() then
            return
        end

        -- Send message with trough info
        toast("Picking up seed from " .. trough.name)

        -- Job
        function job(status, percent)
            set_job("Pick from Seed trough", {
                status = status,
                percent = percent
            })
        end

        -- Move to above the trough
        job("Moving to seed trough", 25)
        move{
            y = trough.y,
            z = trough.z + seeder_tip_z_offset + 25,
            grouping = "xy,z",
            route = "high"
        }

        -- Pick up seed
        job("Picking up seed", 75)
        on(vacuum_pump_pin)
        move{
            z = trough.z + seeder_tip_z_offset - trough_depth,
            speed = 50
        }

        -- Retract Z
        job("Retracting Z", 90)
        move{z=trough.z + seeder_tip_z_offset + 25}
        job("Complete", 100)

:PICK_FROM_SEED_BIN: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
      :body:
      - :kind: parameter_declaration
        :args:
          :label: Seed Bin
          :default_value:
            :kind: location_placeholder
            :args: {}
      - :kind: variable_declaration
        :args:
          :label: Bin Depth
          :data_value:
            :kind: numeric
            :args:
              :number: 20
  :color: yellow
  :name: Pick from Seed Bin
  :body:
  - :kind: lua
    :args:
      :lua: |
        bin = variable("Seed Bin")
        bin_depth = variable("Bin Depth")
        seeder_tool = get_tool({name = "Seeder"})
        seeder_tip_z_offset = seeder_tool.seeder_tip_z_offset or 80
        vacuum_pump_pin = 9

        -- Checks
        if not verify_tool() then
            return
        end

        -- Send message with bin info
        toast("Picking up seed from " .. bin.name)

        -- Job
        function job(status, percent)
            set_job("Pick from Seed Bin", {
                status = status,
                percent = percent
            })
        end

        -- Move to above the bin
        job("Moving to seed bin", 25)
        move{
            x = bin.x,
            y = bin.y,
            z = bin.z + seeder_tip_z_offset + 25,
            grouping = "xy,z",
            route = "high"
        }

        -- Pick up seed
        job("Picking up seed", 75)
        on(vacuum_pump_pin)
        move{
            z = bin.z + seeder_tip_z_offset - bin_depth,
            speed = 50
        }

        -- Retract Z
        job("Retracting Z", 90)
        move{z=bin.z + seeder_tip_z_offset + 25}
        job("Complete", 100)

:PHOTO_GRID: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
  :color: gray
  :name: Photo Grid
  :body:
  - :kind: lua
    :args:
      :lua: |
        local grid = photo_grid()
        job = "Photo Grid"

        grid.each(function(cell)
            set_job(job, {
                percent = 100 * (cell.count - 0.5) / grid.total,
                status = "Moving"
            })
            move{x=cell.x, y=cell.y, z=cell.z}
            set_job(job, {
                percent = 100 * (cell.count / grid.total),
                status = "Taking photo"
            })
            local msg = "Taking photo " .. cell.count .. " of " .. grid.total
            send_message("info", msg)
            take_photo()
        end)

        complete_job(job)

:MOW_ALL_WEEDS: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
  :color: red
  :name: Mow All Weeds
  :body:
  - :kind: lua
    :args:
      :lua: |
        rotary_tool_pin = 2 -- 3 for REV
        max_load = tonumber(env("rotary_tool_max_load")) or 90
        rotary_tool_height = tonumber(env("rotary_tool_height")) or 80
        max_attempts = tonumber(env("rotary_tool_max_attempts")) or 3
        count = 0

        function job(status, percent)
            set_job("Mowing weed at " .. coords, {
                status = status,
                percent = percent
            })
        end

        function parent_job(status, percent)
            set_job("Mowing " .. #weeds .. " weeds", {
                status = status,
                percent = percent
            })
        end

        watcher = function(data)
            if (data.value > max_load) and (env("load") ~= "stalled") then
                env("load", "stalled")
                soft_stop()
                off(rotary_tool_pin)
                toast("Rotary tool max load exceeded (load = " .. data.value .. ")", "warn")
            end
        end

        function attempt_weeding(weed)
            attempts = attempts + 1
            env("load", "nominal")
            job("Moving to weed", 10)
            move{
                x = weed.x - (weed.radius + 50),
                y = weed.y,
                z = weed.z + rotary_tool_height + 20,
                safe_z = true
            }

            on(rotary_tool_pin)

            if env("load") == "stalled" then
                wait(1500)
                return
            end
            job("Descending", 40)
            move{
                z = weed.z + rotary_tool_height,
                speed = 25
            }

            if env("load") == "stalled" then
                wait(1500)
                return
            end
            job("Mowing", 50)
            move{
                x = weed.x + (weed.radius + 50),
                speed = 25
            }

            if env("load") == "stalled" then
                wait(1500)
                return
            end
            job("Ascending", 90)
            move{
                z = weed.z + rotary_tool_height + 20,
                speed = 25
            }

            if env("load") == "stalled" then
                wait(1500)
                return
            end
            off(rotary_tool_pin)
            success = true
        end

        -- Check if tool is mounted to UTM
        if not verify_tool() then
            return
        end

        -- Get all active weeds and sort
        weeds = sort(get_weeds(), "nn")

        -- Interpolate weed Z coordinate from soil height
        for _, weed in pairs(weeds) do
            weed.z = soil_height(weed.x, weed.y)
        end

        -- Initialize load monitoring
        watch_pin(60, watcher)

        -- Main weeding loop
        for _, weed in pairs(weeds) do
            count = count + 1
            parent_job("Mowing weed " .. count .. " of " .. #weeds, count / (#weeds + 1) * 100)
            coords = "(" .. weed.x .. ", " .. weed.y .. ", " .. weed.z .. ")"
            attempts = 0
            success = false
            while (attempts < max_attempts) and (success == false) do
                attempt_weeding(weed)
            end
            if env("load") == "stalled" then
                toast("Mowing weed at " .. coords .. " failed after " .. attempts .. " attempt(s); proceeding...", "warn")
            end
            job("Complete", 100)
        end
        parent_job("Complete", 100)
        toast("Mowing complete", "success")

:GRID: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
      :body:
      - :kind: parameter_declaration
        :args:
          :label: Starting location
          :default_value:
            :kind: coordinate
            :args:
              :x: 0
              :y: 0
              :z: 0
      - :kind: parameter_declaration
        :args:
          :label: Number of points
          :default_value:
            :kind: coordinate
            :args:
              :x: 2
              :y: 3
              :z: 1
      - :kind: parameter_declaration
        :args:
          :label: Spacing
          :default_value:
            :kind: coordinate
            :args:
              :x: 50
              :y: 100
              :z: 0
      - :kind: parameter_declaration
        :args:
          :label: Subsequence
          :default_value:
            :kind: resource_placeholder
            :args:
              :resource_type: Sequence
  :color: gray
  :name: Grid
  :body:
  - :kind: lua
    :args:
      :lua: |
        subsequence = variable("Subsequence")
        grid_points = variable("Number of points")

        local grid = grid{
          grid_points = grid_points,
          start = variable("Starting location"),
          spacing = variable("Spacing")
        }

        job = subsequence.name .. " x" .. grid.total

        toast("Executing `" .. subsequence.name .. "` " .. grid.total ..
              " times in a " .. grid_points.x .. " x " .. grid_points.y ..
              " x " .. grid_points.z .. " grid")

        -- Loop through the grid points
        grid.each(function(cell)
            -- Move
            local grid_point_coordinates = "(" .. cell.x .. ", " .. cell.y .. ", " .. cell.z .. ")"
            set_job(job, {
              percent = 100 * (cell.count - 0.5) / grid.total,
              status = "Moving to " .. grid_point_coordinates
            })
            send_message("info", "Moving to grid point " .. cell.count .. " at " .. grid_point_coordinates)
            move{x=cell.x, y=cell.y, z=cell.z}

            -- Execute subsequence
            set_job(job, {
                percent = 100 * (cell.count / grid.total),
                status = "Executing subsequence"
            })
            send_message("info", "Executing subsequence `" .. subsequence.name .. "`")
            cs_eval(subsequence)
        end)

        complete_job(job)

:DISPENSE_WATER: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
      :body:
      - :kind: parameter_declaration
        :args:
          :label: Water (mL)
          :default_value:
            :kind: numeric
            :args:
              :number: 250
  :color: blue
  :name: Dispense Water
  :body:
  - :kind: lua
    :args:
      :lua: |
        dispense(variable("Water (mL)"))

:WEED_DETECTION_GRID: # ===================================
  :args:
    :locals:
      :kind: scope_declaration
      :args: {}
  :color: gray
  :name: Weed Detection Grid
  :body:
  - :kind: lua
    :args:
      :lua: |
        local grid = photo_grid()
        job = "Weed Detection Grid"

        grid.each(function(cell)
            set_job(job, {
                percent = 100 * (cell.count - 0.5) / grid.total,
                status = "Moving"
            })
            move{x=cell.x, y=cell.y, z=cell.z}
            set_job(job, {
                percent = 100 * (cell.count / grid.total),
                status = "Detecting weeds"
            })
            local msg = "Detecting weeds at location " .. cell.count .. " of " ..
                            grid.total
            send_message("info", msg)
            detect_weeds()
        end)

        complete_job(job)
